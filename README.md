了解競品
可能的錯誤
測試過幾個目前比較大的短網址網站，整理出以下幾個常見錯誤
產生Short URL時，輸入的不是網址
呼叫Short URL時輸入錯誤的Key
如果Key期限，可能也要說已經過期

第一步：需求與目標
首先思考需要甚麼API、API需要的內容
需求1: 縮短網址 
透過Post API 將 Url 傳送至伺服器，判斷此Url是否已經存在。如果存在就回傳現存的Key，如果不存在救生成隨機的KEY，並將URL及KEY傳至Database，並回傳短網址。
是否要設定存活時間?
需求2: 呼叫短網址 
呼叫Get API ，當輸入短網址時，伺服器搜尋KEY是否存在DB中，如果存在就引導至對應網站，否則回傳錯誤。

目標
不能輕易看出短網址與原網址的關聯性
Key不能太好猜，否則會有隱私問題，例如有人是縮短自己的雲端網址等等..
使用短網址時，重新引導過程延遲性低 (生成短網址時使用者比較願意等待，但呼叫短網址時需要回應速度快，所以KEY的搜尋或是DB，要考慮搜尋速度)
生成Short URL實有機制避免使用到同樣的Key，畢竟很可能是用隨機的方式，如果有的話要怎麼辦? 是直接覆蓋舊的還是?

額外需求
同時大量短網址呼叫? 是否能維持可用性
將常呼叫的ShortURL資訊儲存至Cache
生成短網址時是否需要登入，即是否需要使用dev_api_key
短網址過期，需在過期前一個月呼叫時以某種方式提醒

資安層面
避免注入攻擊
限制短時間大量使用，避免遭惡意使用導致許多短網址導向惡意網站，如果有人輸入錯誤的短網址正好連到惡意網站...


第二步：思考讀取頻率&資料庫數據量
在開始建立系統前我認為對於系統的使用預測是很重要的，以這次作業題來說，大概要先思考以下幾點：
建立Short Url的數量、頻率
資料存活時間
新增 Short Url 以、呼叫 Short Url 的使用比例

預先思考使用情況的能幫助預估資料的數量，並依此設計 Short Url 的 Key 長度(這點很重要！方便自己設計出合適的 Key 長度)。

假想我的伺服器服務每個月有100萬筆新資料建立，並且每筆資料能使用3年，超過時間即過期並刪除，那麼在資料庫的數據大約會有3600萬筆。(這個數據會在後面建立Key的步驟用到)

另外要計算同時間可能呼叫 Short Url 的請求數量，假設此系統建立與呼叫比例為1:100，以每月100萬筆建立來計算，每秒鐘~40筆呼叫。



第三步：資料庫設計
項目：
original_url (string)
shortUrl_key (string)
create_date (datetime)
expire_date (datetime)
call_time (int) 



第四步：規劃短網址KEY生成邏輯

原本打算使用UUID產生套件[1]，他會產生128 bits的UUID並以32個字元組成一個字串呈現，例如"6ba7b810-9dad-11d1-80b4-00c04fd430c8"，雖然可以有效確保不會有Key衝突問題，然而要在大量資料庫中尋找對應的Key的過程，如此多字元的資料勢必會大幅降低效率。

最後選擇使用隨機產生Base62亂數做為資料的Key。Base62(a-zA-Z0-9) 以這些字符可以產生62^n中組合，其中n為字符個數。

前面提到資料庫可能會有3600萬筆資料，稍微計算發現至少要使用5個字元(可以產生62^5 ~= 9億個組合，若只用4個字元則只有1500萬不夠使用)。

然而前面目標提過希望這個短網址不會容易被猜中，3600萬/9億~=0.04，代表猜25次就會猜中1個，猜中機率並不低，因此我決定多一碼使用6個Base62的編碼字符來建立Key。

至於產生方式就先以最基礎的隨機產生法，並在產生後先與資料庫比對，若已存在則重新亂數產生。

第五步：規劃API

我選擇使用golang開發中常用的Gin Web框架，一方面是因為許多網路文章推薦，另一方面是他的效能真的很優秀(如下圖)。

圖片來源：https://hackernoon.com/the-myth-about-golang-frameworks-and-external-libraries-93cb4b7da50f

圖片來源：http://qwding.github.io/post/golang_framwork_pk/

並且他跟我習慣的Node.js express Router使用方式很像，沒有不用他的理由阿!

與資料庫連線部分參考https://ithelp.ithome.com.tw/articles/10207409


生成短網址


第六步：部屬資料庫Server、API Server

資料庫使用Azure雲端服務中的SQL server、SQL database、並搭配Microsoft SQL Server Manager Studio(SSMS)進行操作

要注意的是SQL語法中無法使用? 得改用

.env中 PORT變數似乎被Heroku衝突，原本設定為1433然而在heroku呼叫函式時卻變成38560，找了很久才發現，於是把.env中的PORT名稱全部大改

AZURE 防火牆

第七步：規劃Cache

第八步：定期清理資料庫









反省
應該早點用Heroku Config

不習慣
以往使用node.js consolog 在Heroku上都能看見log訊息很好除錯，但是go 的 fmt 卻無法順利印出

額外發想
有沒有可能將新資料的索引值編碼成62進制作為短網址的Key? 
但缺點是1. 如果有Expired或delete的檔案，那個資料位置要空著，不能將後面的資料索引值shift 不然會失效。2. 可能會比較容易被猜中，畢竟Key的規律相對容易發現。

目前建立資料的方式會搜尋URL跟KEY是否存在，很耗時間


—
參考資料：
[1] GoLang UUID 套件 https://pkg.go.dev/github.com/google/uuid#pkg-constants
